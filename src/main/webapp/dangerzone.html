<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title>Danger Zone</title>
        <style type='text/css'>
            body {
                font: 62.5% "Trebuchet MS", sans-serif;
            }
            .spinner {
                background-image: url(/images/spinner.gif);
                background-position: center;
                background-repeat: no-repeat
            }
        </style>
        <link type="text/css" href="css/jquery-ui-1.8.2.custom.css" rel="stylesheet" />
        <script type='text/javascript' src="js/jquery-1.4.2.min.js"></script>
        <script type='text/javascript' src="js/jquery-ui-1.8.2.custom.min.js"></script>
        <script type='text/javascript' src="js/main.js"></script>
        <script type='text/javascript' src="js/protocol.js"></script>
        <script type='text/javascript'>
            if (!window.WebSocket) {
                alert('Sorry, you need a browser that supports WebSockets');
            }

            var protocolhandler;
            $(document).ready(function() {
                var dialog = $("<div></div>").attr("id", "errorDialog");
                dialog.appendTo("body");

                var location = document.location.toString().replace('http://','ws://').replace('https://','wss://').replace('.html','');
                var props = {
                    "onopen" : dzOnOpen,
                    "onclose" : dzOnClose,
                    "onclientconnect" : showClients,
                    "onclientdisconnect" : showClients,
                    "onclientchange" : showClients
                };
                protocolhandler = new ProtocolHandler(props);
                protocolhandler.connect(location);
            });

            var ratesPeriod = 2;
            var ratesInterval;
            var clientsInterval;
            function dzOnOpen(zone) {
                $('#main').removeClass('spinner');
                showRates();
                ratesInterval = setInterval(showRates, ratesPeriod * 1000);
                showClients();
                clientsInterval = setInterval(showClients, 5000);
            }

            function dzOnClose(zone) {
                $('#main').removeClass('spinner');
                clearInterval(ratesInterval);
                showRates();
                clearInterval(clientsInterval);
                showClients();
                setTimeout('alert("Connection lost")', 1);
            }

            var oldPktRecv = 0;
            var oldPktSent = 0;
            function showRates() {
                var txt;
                if (protocolhandler.isConnected()) {
                    var pin = protocolhandler.pktRecv;
                    var pout = protocolhandler.pktSent;
                    var din = (pin - oldPktRecv) / ratesPeriod;
                    var dout = (pout - oldPktSent) / ratesPeriod;
                    oldPktRecv = pin;
                    oldPktSent = pout;
                    txt = "In: " + din + " pkt/s, Out: " + dout + " pkt/s";
                } else {
                    txt = 'Disconnected';
                }
                $('#rates').text(txt);
            }

            function showClients() {
                var txt;
                if (protocolhandler.isConnected()) {
                    txt = "";
                    for (id in protocolhandler.clients) {
                        var client = protocolhandler.clients[id];
                        txt = txt + "<li>" + client.name + "</li>";
                    }
                } else {
                    txt = 'Disconnected';
                }
                $('#clients').html(txt);
            }

            function setName() {
                var me = __copy(protocolhandler.clients[protocolhandler.id]);
                me.name = $("#name").val();
                protocolhandler.send("sys", "client", me);
                return false;
            }
        </script>
    </head>
    <body id="main" class="spinner">
        <div id="rates">Disconnected</div>
        <br>
        <div id="clients">Disconnected</div>
        <br>
        <input id="name" type="text" name="name">
        <input type="button" value="Set Name" onClick="setName()">
        <br>
        <br>
    </body>
</html>
